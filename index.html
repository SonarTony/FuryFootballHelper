<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fury Football – Browser Helper (HTML/JS)</title>
<style>
  :root { --panel:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f8fafc,#eef2f7);color:var(--ink)}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;gap:16px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:1.6rem}
  .sub{margin:4px 0 0;color:var(--muted);font-size:.9rem}
  .row{display:grid;grid-template-columns:1fr;gap:24px}
  @media(min-width:1024px){.row{grid-template-columns:2fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .hd h2{margin:0;font-size:1rem}
  .bd{padding:16px}
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media(max-width:640px){.grid-4{grid-template-columns:repeat(2,1fr)}}
  .die{border:1px solid var(--line);background:#fff;border-radius:12px;padding:12px}
  .die .lbl{font-size:.75rem;color:var(--muted)}
  .die .val{font-size:1.2rem;font-weight:700}
  .die .sub{font-size:.72rem;color:#9ca3af}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font:inherit}
  .btn{background:#111827;color:#fff;padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.outline{background:#fff;color:#111827;border:1px solid var(--line)}
  .badge{display:inline-flex;align-items:center;border:1px solid var(--line);background:#fff;padding:3px 8px;border-radius:999px;font-size:.75rem}
  .history{max-height:560px;overflow:auto;padding-right:6px}
  .histItem{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .histRow{display:flex;gap:8px;flex-wrap:wrap;font-size:.8rem;color:#334155}
  .ibox{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .ibox .t{font-size:.72rem;color:var(--muted);font-weight:700}
  .result{border:1px solid var(--line);background:#f8fafc;border-radius:12px;padding:10px}
  .tabs{display:grid;gap:12px}
  .tabButtons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .tabButtons .btn{width:100%;background:#f1f5f9;color:#0f172a}
  .zoneGrid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.zoneGrid{grid-template-columns:1fr 1fr}}
  .zoneCol .ttl{font-size:.9rem;color:#475569;font-weight:700;margin-bottom:8px}
  .cell{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .cell .k{font-size:.72rem;color:var(--muted);font-weight:700;margin-bottom:6px}
  .chartTable{width:100%;border-collapse:collapse}
  .chartTable th,.chartTable td{border-top:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  .chartTable th{background:#f1f5f9;font-size:.75rem}
  .muted{color:var(--muted)}
  .tip{font-size:.75rem;color:var(--muted)}
  .rowGap{display:grid;gap:24px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Fury Football – Browser Helper</h1>
        <p class="sub">1d20 + black d6 (Off: Audible/Run/Pass) + white d6 (Def: Gotcha!/React/Pass/Run/Fury) + Fury d6. 1–12: player cards. 13–20: defense selects the chart; Gotcha! = loss of down.</p>
      </div>
      <div class="controls">
        <button id="btnExport" class="btn outline">Export JSON</button>
        <label class="btn outline" for="fileImport" style="display:inline-flex;align-items:center;gap:8px;">
          Import JSON <input id="fileImport" type="file" accept="application/json" style="display:none" />
        </label>
      </div>
    </header>

    <div class="row">
      <!-- Roller -->
      <div class="card">
        <div class="hd">
          <h2>Dice Roller</h2>
          <div class="controls">
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="muted" style="font-size:.8rem;">Seed</span>
              <input id="seed" class="input" placeholder="optional" style="width:160px;" />
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="muted" style="font-size:.8rem;">Zone</span>
              <select id="zone" class="input" style="width:150px;">
                <option value="white">White Zone</option>
                <option value="red">Red Zone</option>
              </select>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="grid grid-4">
            <div class="die"><div class="lbl">d20</div><div class="val">1–20</div></div>
            <div class="die"><div class="lbl">Black d6</div><div class="val">1–6</div><div class="sub">Offense</div></div>
            <div class="die"><div class="lbl">White d6</div><div class="val">1–6</div><div class="sub">Defense</div></div>
            <div class="die"><div class="lbl">Fury d6</div><div class="val" id="furyFacesPreview">▲ ● ● ● ■ ■</div><div class="sub">customizable</div></div>
          </div>

          <div class="controls" style="margin-top:12px;">
            <button id="btnRoll" class="btn">Roll</button>
            <button id="btnClear" class="btn outline">Clear</button>
          </div>

          <div id="resultPanel" style="margin-top:16px;">
            <div class="tip">Roll to see results. For 13–20, defense chooses the chart (React/Pass/Run/Fury). Gotcha! = automatic loss of down.</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <div class="hd"><h2>Roll History</h2></div>
        <div class="bd history" id="history"></div>
      </div>
    </div>

    <!-- Configuration -->
    <div class="card" style="margin-top:24px;">
      <div class="hd"><h2>Configuration & Data</h2></div>
      <div class="bd tabs">
        <div class="tabButtons">
          <button class="btn" data-tab="offense">Offense (Black d6)</button>
          <button class="btn" data-tab="defense">Defense (White d6)</button>
          <button class="btn" data-tab="charts">Play Charts 13–20</button>
          <button class="btn" data-tab="fury">Fury Die & Effects</button>
        </div>

        <!-- Offense -->
        <div class="tab" id="tab-offense">
          <div class="zoneGrid">
            <div class="zoneCol">
              <div class="ttl">White Zone</div>
              <div class="grid grid-3" id="off-white"></div>
            </div>
            <div class="zoneCol">
              <div class="ttl">Red Zone</div>
              <div class="grid grid-3" id="off-red"></div>
            </div>
          </div>
        </div>

        <!-- Defense -->
        <div class="tab" id="tab-defense" style="display:none;">
          <div class="zoneGrid">
            <div class="zoneCol">
              <div class="ttl">White Zone</div>
              <div class="grid grid-3" id="def-white"></div>
            </div>
            <div class="zoneCol">
              <div class="ttl">Red Zone</div>
              <div class="grid grid-3" id="def-red"></div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="tab" id="tab-charts" style="display:none;">
          <div class="rowGap">
            <div class="chart" data-chart="react"></div>
            <div class="chart" data-chart="fury"></div>
            <div class="chart" data-chart="pass"></div>
            <div class="chart" data-chart="run"></div>
          </div>
        </div>

        <!-- Fury -->
        <div class="tab" id="tab-fury" style="display:none;">
          <div class="ibox" style="margin-bottom:12px;">
            <div class="t">Fury Die Faces (6)</div>
            <div class="grid grid-3" id="furyFacesGrid" style="margin-top:8px;"></div>
          </div>
          <div class="grid grid-3" id="furyEffectsGrid"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =======================
   Persistent State + Defaults
   ======================= */
const STORAGE_KEY = 'fury-football-helper-v4-html';

const defaultData = {
  meta: { name: "Fury Football Set (Defense picks chart; Gotcha = LOD)", version: 4 },
  furyDieFaces: ["▲","●","●","●","■","■"],
  furyEffects: {
    "▲": "Triangle: Momentum surge (offense +1 to next player check)",
    "●": "Circle: No special effect",
    "■": "Square: Wild card — consult FURY chart note"
  },
  zoneNames: { white: "White Zone", red: "Red Zone" },

  /* Black d6 → Offense: 'audible' | 'run' | 'pass' */
  offenseCharts: {
    white: { 1:{call:"audible",note:""},2:{call:"audible",note:""},3:{call:"run",note:""},4:{call:"run",note:""},5:{call:"pass",note:""},6:{call:"pass",note:""} },
    red:   { 1:{call:"audible",note:""},2:{call:"audible",note:""},3:{call:"run",note:""},4:{call:"run",note:""},5:{call:"pass",note:""},6:{call:"pass",note:""} }
  },

  /* White d6 → Defense: 'gotcha' | 'react' | 'pass' | 'run' | 'fury' */
  defenseCharts: {
    white: {
      1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""}, 3:{choice:"pass",note:""},
      4:{choice:"run",note:""},    5:{choice:"fury",note:""},  6:{choice:"react",note:""}
    },
    red: {
      1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""}, 3:{choice:"pass",note:""},
      4:{choice:"run",note:""},    5:{choice:"fury",note:""},  6:{choice:"react",note:""}
    }
  },

  /* Play charts 13–20 (each row has pass/run text) */
  playCharts: {
    react: { 13:{pass:"Pass: Defensive Player [1]", run:"Run: Defensive Player [4]"},
             14:{pass:"Pass: Defensive Player [2]", run:"Run: Defensive Player [5]"},
             15:{pass:"Pass: Defensive Player [2]", run:"Run: Defensive Player [5]."},
             16:{pass:"Pass: Defensive Player [3]", run:"Run: Defensive Player [6]"},
             17:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
             18:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
             19:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
             20:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"}},
    fury:  { 13:{pass:"Pass: SACK! (-1D6 LOSS)", run:"Run: FUMBLE!"},
             14:{pass:"Pass: INTERCEPTION!", run:"Run: MEDIUM GAIN (2D6)"},
             15:{pass:"Pass: LONG GAIN (3D6).", run:"Run: LOSS (-1D6)"},
             16:{pass:"Pass: Defensive Player [5]", run:"Run: Defensive Player [2]"},
             17:{pass:"Pass: LONG GAIN (3D6).", run:"Run: LOSS (-1D6)"},
             18:{pass:"Pass: SACK (-1D6)", run:"Run: LOSS (-1D6)"},
             19:{pass:"Pass: FUMBLE", run:"Run: LONG GAIN (3D6)"},
             20:{pass:"Pass: Offensive Player [12]", run:"Offensive Player [12]"}},
    pass:  { 13:{pass:"Pass: INTERCEPTION!", run:"Run: TOUCHDOWN!"},
             14:{pass:"Pass: INTERCEPTION!", run:"Run: SHORT GAIN (1D6)"},
             15:{pass:"Pass: INCOMPLETE!", run:"Run: MEDIUM GAIN (2D6)"},
             16:{pass:"Pass: INCOMPLETE!", run:"Run: Offensive Player [12]"},
             17:{pass:"Pass: Post explosive.", run:"Run: RPO stuff — check LB."},
             18:{pass:"Pass: Corner toe-tap.", run:"Run: Jet tap for 6."},
             19:{pass:"Pass: Check pass rush.", run:"Run: Box light — 7."},
             20:{pass:"Pass: Perfect ball.", run:"Run: Check hustle TD?"}},
    run:   { 13:{pass:"Pass: Check OC rage.", run:"Run: Power for 3."},
             14:{pass:"Pass: Fans boo.", run:"Run: Zone slice 5."},
             15:{pass:"Pass: DC smiles.", run:"Run: Counter 7."},
             16:{pass:"Pass: Audible to post.", run:"Run: Toss 6."},
             17:{pass:"Pass: Coach fumes.", run:"Run: Trap 2."},
             18:{pass:"Pass: Crowd puzzled.", run:"Run: Sweep 9."},
             19:{pass:"Pass: Lucky checkdown.", run:"Run: Break tackle 12."},
             20:{pass:"Pass: Miracle bomb.", run:"Run: House call!"} }
  }
};

function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):structuredClone(defaultData);}catch(e){return structuredClone(defaultData)} }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); }

/* RNG */
function mulberry32(a){return function(){var t=(a+=0x6d2b79f5);t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296}}
function seedToRng(seed){ if(!seed) return Math.random; let s=0; for(let i=0;i<seed.length;i++) s=(s*31+seed.charCodeAt(i))>>>0; return mulberry32(s||1) }
const rollD=(rng,s)=>Math.floor(rng()*s)+1;

/* App State */
let State = loadState();
let History = [];
let currentTab = 'offense';
function $(q){return document.querySelector(q)}
function $all(q){return Array.from(document.querySelectorAll(q))}

/* UI */
function renderAll(){
  $('#furyFacesPreview').textContent=(State.furyDieFaces||[]).join(' ');
  renderResultPanel(null); renderHistory(); renderOffenseGrid(); renderDefenseGrid(); renderCharts(); renderFuryEditors();
  $all('.tabButtons .btn').forEach(b=>{ b.onclick=()=>switchTab(b.dataset.tab) }); switchTab(currentTab);
  const zoneSel=$('#zone'); zoneSel.options[0].text=State.zoneNames?.white||'White Zone'; zoneSel.options[1].text=State.zoneNames?.red||'Red Zone';
}
function renderResultPanel(last){
  const panel=$('#resultPanel');
  if(!last){ panel.innerHTML='<div class="tip">Roll to see results. For 13–20, defense picks the chart (React/Pass/Run/Fury). Gotcha! = loss of down.</div>'; return; }
  const zoneLabel=State.zoneNames?.[last.zone]||(last.zone==='red'?'Red Zone':'White Zone');

  let routeHTML='';
  if(last.route.type==='player'){
    routeHTML=`<p><b>Route:</b> Player Card Check — use d20=${last.route.number}.</p>`;
  }else if(last.route.type==='gotcha'){
    routeHTML=`<p><b>Route:</b> <span class="badge">Gotcha! — Loss of Down</span></p>`;
  }else if(last.route.type==='chart-single'){
    routeHTML=`<p><b>Route:</b> <b>${last.route.chart.toUpperCase()}</b> • #${last.route.number} • <b>${last.route.call.toUpperCase()}</b></p>`;
  }else if(last.route.type==='chart-both'){
    routeHTML=`<p><b>Route:</b> <b>${last.route.chart.toUpperCase()}</b> • #${last.route.number} (choose Pass or Run)</p>`;
  }

  panel.innerHTML=`
    <div class="grid grid-4" style="gap:8px;margin-bottom:8px;">
      <span class="badge">Zone: ${zoneLabel}</span>
      <span class="badge">d20: ${last.d20}</span>
      <span class="badge">Black d6 (Off): ${last.black} → ${(last.offense?.call||'?').toUpperCase()}</span>
      <span class="badge">White d6 (Def): ${last.white} → ${(last.defense?.choice||'?').toUpperCase()}</span>
      <span class="badge">Fury: ${last.furyFace}</span>
    </div>
    <div style="margin-bottom:8px;">${routeHTML}</div>
    <div class="grid grid-3">
      <div class="ibox"><div class="t">Offense Call</div>
        <div>${last.offense?`<div>Call: <b>${(last.offense.call||'').toUpperCase()}</b></div>${last.offense.note?`<div class="muted" style="font-size:.85rem;">${last.offense.note}</div>`:''}`:'<i>Not set</i>'}</div>
      </div>
      <div class="ibox"><div class="t">Defense</div>
        <div>${last.defense?`<div>Choice: <b>${(last.defense.choice||'').toUpperCase()}</b></div>${last.defense.note?`<div class="muted" style="font-size:.85rem;">${last.defense.note}</div>`:''}`:'<i>Not set</i>'}</div>
      </div>
      <div class="ibox"><div class="t">Fury Effect</div><div>${last.furyEffect||'No special effect'}</div></div>
    </div>
    ${last.result?`<div class="result" style="margin-top:8px;"><div class="t" style="font-weight:700;">Result</div><div>${last.result}</div></div>`:''}
    <div class="tip" style="margin-top:6px;">Tip: Customize mappings below — data auto-saves to your browser.</div>
  `;
}
function renderHistory(){
  const box=$('#history');
  if(!History.length){ box.innerHTML=`<div class="muted" style="font-size:.9rem;">No rolls yet.</div>`; return; }
  box.innerHTML=History.map(h=>`
    <div class="histItem">
      <div class="histRow">
        <span class="badge">d20 ${h.d20}</span>
        <span class="badge">Off ${h.black}→${(h.offense?.call||'').toUpperCase()}</span>
        <span class="badge">Def ${h.white}→${(h.defense?.choice||'').toUpperCase()}</span>
        <span class="badge">Fury ${h.furyFace}</span>
        <span class="badge">${h.zone}</span>
        ${h.route.type==='gotcha'?'<span class="badge">Gotcha! LOD</span>':''}
      </div>
      <div style="margin-top:6px;font-size:.9rem;">
        ${
          h.route.type==='player' ? 'Player card check.'
          : h.route.type==='gotcha' ? 'Loss of down.'
          : h.route.type==='chart-single' ? `${h.route.chart.toUpperCase()} #${h.route.number} ${h.route.call.toUpperCase()}`
          : `${h.route.chart.toUpperCase()} #${h.route.number} (Pick Pass/Run)`
        }
      </div>
      ${h.result?`<div class="tip" style="margin-top:4px;">${h.result}</div>`:''}
    </div>
  `).join('');
}
function renderOffenseGrid(){
  const CALLS=['audible','run','pass'];
  const makeCell=(zone,i)=>{
    const val=State.offenseCharts?.[zone]?.[i]||{call:'audible',note:''};
    return `
      <div class="cell">
        <div class="k">Black d6 = ${i}</div>
        <select data-off-${zone}-${i}-call class="input">
          ${CALLS.map(c=>`<option value="${c}" ${val.call===c?'selected':''}>${c}</option>`).join('')}
        </select>
        <div style="margin-top:6px;"><input data-off-${zone}-${i}-note class="input" placeholder="note (optional)" value="${val.note||''}"></div>
      </div>`;
  };
  $('#off-white').innerHTML=[1,2,3,4,5,6].map(i=>makeCell('white',i)).join('');
  $('#off-red').innerHTML  =[1,2,3,4,5,6].map(i=>makeCell('red',i)).join('');
  ['white','red'].forEach(zone=>{
    [1,2,3,4,5,6].forEach(i=>{
      $(`select[data-off-${zone}-${i}-call]`).onchange=e=>{ ensure(State.offenseCharts[zone],i); State.offenseCharts[zone][i].call=e.target.value; saveState(); };
      $(`input[data-off-${zone}-${i}-note]`).oninput=e=>{ ensure(State.offenseCharts[zone],i); State.offenseCharts[zone][i].note=e.target.value; saveState(); if(History[0]) renderResultPanel(History[0]); };
    });
  });
}
function renderDefenseGrid(){
  const CHOICES=['gotcha','react','pass','run','fury'];
  const makeCell=(zone,i)=>{
    const val=State.defenseCharts?.[zone]?.[i]||{choice:'react',note:''};
    return `
      <div class="cell">
        <div class="k">White d6 = ${i}</div>
        <select data-def-${zone}-${i}-choice class="input">
          ${CHOICES.map(c=>`<option value="${c}" ${val.choice===c?'selected':''}>${c}</option>`).join('')}
        </select>
        <div style="margin-top:6px;"><input data-def-${zone}-${i}-note class="input" placeholder="note (optional)" value="${val.note||''}"></div>
      </div>`;
  };
  $('#def-white').innerHTML=[1,2,3,4,5,6].map(i=>makeCell('white',i)).join('');
  $('#def-red').innerHTML  =[1,2,3,4,5,6].map(i=>makeCell('red',i)).join('');
  ['white','red'].forEach(zone=>{
    [1,2,3,4,5,6].forEach(i=>{
      $(`select[data-def-${zone}-${i}-choice]`).onchange=e=>{ ensure(State.defenseCharts[zone],i); State.defenseCharts[zone][i].choice=e.target.value; saveState(); if(History[0]) renderResultPanel(History[0]); };
      $(`input[data-def-${zone}-${i}-note]`).oninput=e=>{ ensure(State.defenseCharts[zone],i); State.defenseCharts[zone][i].note=e.target.value; saveState(); if(History[0]) renderResultPanel(History[0]); };
    });
  });
}
function renderCharts(){
  ['react','fury','pass','run'].forEach(name=>{
    const holder=document.querySelector(`.chart[data-chart="${name}"]`);
    holder.innerHTML=`
      <div class="ibox" style="overflow:auto;">
        <div class="t" style="font-size:.9rem;margin-bottom:8px;">${name[0].toUpperCase()+name.slice(1)} Chart</div>
        <table class="chartTable">
          <thead><tr><th style="width:60px;">#</th><th>Pass</th><th>Run</th></tr></thead>
          <tbody>
            ${Array.from({length:8},(_,k)=>13+k).map(n=>`
              <tr>
                <td><b>${n}</b></td>
                <td><textarea data-chart="${name}" data-row="${n}" data-col="pass" class="input" rows="2">${(State.playCharts?.[name]?.[n]?.pass)||''}</textarea></td>
                <td><textarea data-chart="${name}" data-row="${n}" data-col="run" class="input" rows="2">${(State.playCharts?.[name]?.[n]?.run)||''}</textarea></td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  });
  $all('textarea[data-chart]').forEach(el=>{
    el.oninput=_=>{
      const name=el.dataset.chart, row=parseInt(el.dataset.row,10), col=el.dataset.col;
      if(!State.playCharts[name]) State.playCharts[name]={};
      if(!State.playCharts[name][row]) State.playCharts[name][row]={pass:'',run:''};
      State.playCharts[name][row][col]=el.value; saveState(); if(History[0]) renderResultPanel(History[0]);
    };
  });
}
function renderFuryEditors(){
  const facesGrid=$('#furyFacesGrid'); facesGrid.innerHTML='';
  (State.furyDieFaces||[]).forEach((face,idx)=>{
    const wrap=document.createElement('div');
    wrap.innerHTML=`<div class="ibox"><div class="t">Face ${idx+1}</div><input class="input" data-fury-face="${idx}" value="${face}"></div>`;
    facesGrid.appendChild(wrap.firstElementChild);
  });
  $all('input[data-fury-face]').forEach(inp=>{
    inp.oninput=_=>{ const i=parseInt(inp.dataset.furyFace,10); State.furyDieFaces[i]=inp.value||''; saveState(); $('#furyFacesPreview').textContent=(State.furyDieFaces||[]).join(' '); renderFuryEffectsEditors(); };
  });
  renderFuryEffectsEditors();
}
function renderFuryEffectsEditors(){
  const grid=$('#furyEffectsGrid'); grid.innerHTML='';
  const uniq=Array.from(new Set(State.furyDieFaces));
  uniq.forEach(sym=>{
    const div=document.createElement('div'); div.className='ibox';
    div.innerHTML=`<div class="t">Effect for <b>${sym||'(blank)'}</b></div><textarea rows="3" class="input" data-fury-effect="${sym}">${State.furyEffects?.[sym]||''}</textarea>`;
    grid.appendChild(div);
  });
  $all('textarea[data-fury-effect]').forEach(t=>{
    t.oninput=_=>{ const sym=t.dataset.furyEffect; State.furyEffects[sym]=t.value; saveState(); if(History[0]) renderResultPanel(History[0]); };
  });
}
function ensure(obj,i){ if(!obj[i]) obj[i]={}; }

/* Tabs */
function switchTab(name){
  currentTab=name;
  $('#tab-offense').style.display=(name==='offense')?'':'none';
  $('#tab-defense').style.display=(name==='defense')?'':'none';
  $('#tab-charts').style.display =(name==='charts')?'':'none';
  $('#tab-fury').style.display   =(name==='fury')?'':'none';
}

/* Helpers */
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* Rolling Logic */
function rollAll(){
  const zone=$('#zone').value;
  const rng=seedToRng($('#seed').value.trim());
  const d20=rollD(rng,20), black=rollD(rng,6), white=rollD(rng,6), furyIdx=rollD(rng,6);
  const furyFace=(State.furyDieFaces&&State.furyDieFaces[furyIdx-1])||["▲","●","●","●","■","■"][furyIdx-1];

  const off=State.offenseCharts?.[zone]?.[black];
  const def=State.defenseCharts?.[zone]?.[white];

  let route={type:'player',number:d20}, playResult=null;

  if(d20>=13 && d20<=20){
    const offCall=(off&&off.call)?off.call:'run';            // audible|run|pass
    const defChoice=(def&&def.choice)?def.choice:'react';    // gotcha|react|pass|run|fury

    if(defChoice==='gotcha'){
      // Automatic loss of down — no chart resolution
      route={type:'gotcha'};
      playResult='Gotcha! Automatic loss of down.';
    } else {
      // Defense selects the chart
      const chartName = defChoice; // 'react' | 'pass' | 'run' | 'fury'
      const row = State.playCharts?.[chartName]?.[d20] || {};

      if(offCall==='audible'){
        const passTxt=row.pass||'(no pass entry)';
        const runTxt =row.run ||'(no run entry)';
        playResult=`<b>${chartName.toUpperCase()} ${d20}</b><br>Pass → ${escapeHTML(passTxt)}<br>Run → ${escapeHTML(runTxt)}`;
        route = { type:'chart-both', chart:chartName, number:d20 };
      } else if(offCall==='pass'){
        const txt=row.pass||`No entry for ${chartName.toUpperCase()} ${d20} PASS.`;
        playResult=escapeHTML(txt);
        route = { type:'chart-single', chart:chartName, call:'pass', number:d20 };
      } else {
        const txt=row.run||`No entry for ${chartName.toUpperCase()} ${d20} RUN.`;
        playResult=escapeHTML(txt);
        route = { type:'chart-single', chart:chartName, call:'run', number:d20 };
      }
    }
  }

  const furyEffect=(State.furyEffects&&State.furyEffects[furyFace])||'No special effect';

  const entry={ts:Date.now(),zone,d20,black,white,furyIdx,furyFace,offense:off,defense:def,route,result:playResult,furyEffect};
  History.unshift(entry); History=History.slice(0,60);
  renderResultPanel(entry); renderHistory();
}

/* Import / Export */
function exportJSON(){ const blob=new Blob([JSON.stringify(State,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; const name=(State.meta&&State.meta.name)?State.meta.name.replace(/\s+/g,'-'):'dataset'; a.download=`fury-football-${name}.json`; a.click(); URL.revokeObjectURL(url); }
function importJSON(file){ const r=new FileReader(); r.onload=e=>{ try{ const obj=JSON.parse(e.target.result); State=Object.assign(structuredClone(defaultData),obj); saveState(); renderAll(); }catch(_){ alert('Invalid JSON file.'); } }; r.readAsText(file); }

/* Wire Up */
window.addEventListener('DOMContentLoaded', ()=>{
  renderAll();
  $('#btnRoll').onclick=rollAll;
  $('#btnClear').onclick=()=>{History=[];renderHistory();renderResultPanel(null);}
  $('#btnExport').onclick=exportJSON;
  $('#fileImport').onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; };
});
</script>
</body>
</html>
