<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fury Football – Browser Helper (HTML/JS)</title>
<style>
  :root { --panel:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f8fafc,#eef2f7);color:var(--ink)}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;gap:16px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:1.6rem}
  .sub{margin:4px 0 0;color:var(--muted);font-size:.9rem}
  .row{display:grid;grid-template-columns:1fr;gap:24px}
  @media(min-width:1024px){.row{grid-template-columns:2fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .hd h2{margin:0;font-size:1rem}
  .bd{padding:16px}
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media(max-width:640px){.grid-4{grid-template-columns:repeat(2,1fr)}}
  .die{border:1px solid var(--line);background:#fff;border-radius:12px;padding:12px}
  .die .lbl{font-size:.75rem;color:var(--muted)}
  .die .val{font-size:1.2rem;font-weight:700}
  .die .sub{font-size:.72rem;color:#9ca3af}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font:inherit}
  .btn{background:#111827;color:#fff;padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.outline{background:#fff;color:#111827;border:1px solid var(--line)}
  .badge{display:inline-flex;align-items:center;border:1px solid var(--line);background:#fff;padding:3px 8px;border-radius:999px;font-size:.75rem}
  .history{max-height:560px;overflow:auto;padding-right:6px}
  .histItem{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .histRow{display:flex;gap:8px;flex-wrap:wrap;font-size:.8rem;color:#334155}
  .ibox{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .ibox .t{font-size:.72rem;color:var(--muted);font-weight:700}
  .result{border:1px solid var(--line);background:#f8fafc;border-radius:12px;padding:10px}
  .seg{display:flex;gap:6px;align-items:center;background:#fff;border:1px solid var(--line);padding:4px;border-radius:10px}
  .seg input{display:none}
  .seg label{padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.85rem}
  .seg input:checked + label{background:#111827;color:#fff}
  .coachRow{display:flex;flex-wrap:wrap;gap:10px}
  .coachBlock{border:1px solid var(--line);padding:8px;border-radius:10px;background:#fff}
  .coachBlock .lbl{font-size:.72rem;color:var(--muted);margin-bottom:4px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.86rem}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Fury Football – Browser Helper</h1>
        <p class="sub">
          Gotcha = defense guessed correctly (no auto loss). Audible shows <b>TENDENCY</b> (no Pass/Run auto-pick).
          Gotcha + Audible → <b>FURY</b> chart with <b>TENDENCY</b> (both Pass/Run lines shown).
          d20 1–12: player card check.
        </p>
      </div>
      <div class="controls">
        <button id="btnExport" class="btn outline">Export JSON</button>
        <label class="btn outline" for="fileImport" style="display:inline-flex;align-items:center;gap:8px;">
          Import JSON <input id="fileImport" type="file" accept="application/json" style="display:none" />
        </label>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px;">
      <div class="hd"><h2>Pre-Game Coach Selection (hardcoded presets)</h2></div>
      <div class="bd">
        <div class="coachRow">
          <div class="coachBlock">
            <div class="lbl">Home Offense Coach</div>
            <select id="selHomeOff" class="input" style="width:200px;"></select>
          </div>
          <div class="coachBlock">
            <div class="lbl">Home Defense Coach</div>
            <select id="selHomeDef" class="input" style="width:200px;"></select>
          </div>
          <div class="coachBlock">
            <div class="lbl">Visitor Offense Coach</div>
            <select id="selAwayOff" class="input" style="width:200px;"></select>
          </div>
          <div class="coachBlock">
            <div class="lbl">Visitor Defense Coach</div>
            <select id="selAwayDef" class="input" style="width:200px;"></select>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Roller -->
      <div class="card">
        <div class="hd">
          <h2>Dice Roller</h2>
          <div class="controls" style="flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="muted" style="font-size:.8rem;">Seed</span>
              <input id="seed" class="input" placeholder="optional" style="width:160px;" />
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="muted" style="font-size:.8rem;">Zone</span>
              <select id="zone" class="input" style="width:150px;">
                <option value="white">White Zone</option>
                <option value="red">Red Zone</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="muted" style="font-size:.8rem;">Possession</span>
              <div class="seg" id="posseg">
                <input type="radio" name="pos" id="posHome" value="home" checked><label for="posHome">Home</label>
                <input type="radio" name="pos" id="posAway" value="away"><label for="posAway">Visitor</label>
              </div>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="grid grid-4">
            <div class="die"><div class="lbl">d20</div><div class="val">1–20</div></div>
            <div class="die"><div class="lbl">Black d6 (Off)</div><div class="val">1–6</div><div class="sub" id="offTeamTag">Home Offense</div></div>
            <div class="die"><div class="lbl">White d6 (Def)</div><div class="val">1–6</div><div class="sub" id="defTeamTag">Visitor Defense</div></div>
            <div class="die"><div class="lbl">Fury d6</div><div class="val" id="furyFacesPreview">▲ ● ● ● ■ ■</div><div class="sub">customizable</div></div>
          </div>

          <!-- Extra yardage dice -->
          <div class="grid grid-3" style="margin-top:12px;">
            <div class="die"><div class="lbl">Short</div><div class="val" id="shortVal">1d6</div><div class="sub">extra roll</div></div>
            <div class="die"><div class="lbl">Medium</div><div class="val" id="mediumVal">2d6</div><div class="sub mono" id="mediumBreak"></div></div>
            <div class="die"><div class="lbl">Long</div><div class="val" id="longVal">3d6</div><div class="sub mono" id="longBreak"></div></div>
          </div>

          <div class="controls" style="margin-top:12px;">
            <button id="btnRoll" class="btn">Roll</button>
            <button id="btnClear" class="btn outline">Clear</button>
          </div>

          <div id="resultPanel" style="margin-top:16px;">
            <div class="sub">Audible → TENDENCY (no auto Pass/Run). If a chart is needed, both Pass and Run lines are shown.</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <div class="hd"><h2>Roll History</h2></div>
        <div class="bd history" id="history"></div>
      </div>
    </div>

    <!-- Fury Config only -->
    <div class="card" style="margin-top:24px;">
      <div class="hd"><h2>Fury Die & Effects</h2></div>
      <div class="bd">
        <div class="ibox" style="margin-bottom:12px;">
          <div class="t">Fury Die Faces (6)</div>
          <div class="grid grid-3" id="furyFacesGrid" style="margin-top:8px;"></div>
        </div>
        <div class="grid grid-3" id="furyEffectsGrid"></div>
      </div>
    </div>
  </div>

<script>
/* =======================
   Persistent State + Defaults (with migration)
   ======================= */
const STORAGE_KEY = 'fury-football-helper-v13-html';
function structuredClone(obj){ return JSON.parse(JSON.stringify(obj)); }

const defaultDieOffense = {
  white: { 1:{call:"audible",note:""},2:{call:"audible",note:""},3:{call:"run",note:""},4:{call:"run",note:""},5:{call:"pass",note:""},6:{call:"pass",note:""} },
  red:   { 1:{call:"audible",note:""},2:{call:"audible",note:""},3:{call:"run",note:""},4:{call:"run",note:""},5:{call:"pass",note:""},6:{call:"pass",note:""} }
};
const defaultDieDefense = {
  white: {
    1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""}, 3:{choice:"pass",note:""},
    4:{choice:"run",note:""},    5:{choice:"fury",note:""},  6:{choice:"react",note:""}
  },
  red: {
    1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""}, 3:{choice:"pass",note:""},
    4:{choice:"run",note:""},    5:{choice:"fury",note:""},  6:{choice:"react",note:""}
  }
};

/* === COACH_PRESETS (exactly as provided) === */
const COACH_PRESETS = {
  offense: {
    Default: structuredClone(defaultDieOffense),
    AAAA: {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"gain",note:""}
      }
    },
   AAA: {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    AA: {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"tendency",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    A:  {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"tendency",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    B:  {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"tendency",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"trend",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    C:  {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"no gain",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"tendency",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    D:  {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"tendency",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"penalized",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    F:  {
      white: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"turnover",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      },
      red: {
        1:{call:"pass",note:""}, 2:{call:"pass",note:""},
        3:{call:"penalized",note:""},     4:{call:"run",note:""},
        5:{call:"run",note:""},    6:{call:"audible",note:""}
      }
    },
    },
  defense: {
    Default: structuredClone(defaultDieDefense),
    AAAA: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    AAA: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"no gain",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"turnover",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    AA: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"no gain",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    A: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
   B:  {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gotcha",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    C: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"react",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gain",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    D: {
      white: {
        1:{choice:"gotcha",note:""}, 2:{choice:"penalized",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"gain",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
    F: {
      white: {
        1:{choice:"gain",note:""}, 2:{choice:"react",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      },
      red: {
        1:{choice:"gotcha",note:""}, 2:{choice:"penalized",note:""},
        3:{choice:"react",note:""},   4:{choice:"pass",note:""},
        5:{choice:"run",note:""},   6:{choice:"fury",note:""}
      }
    },
  },
};

/* ===== PLAY CHARTS (13–20) – EXACTLY AS YOU PROVIDED ===== */
const PLAY_CHARTS = {
  react: {
    13:{pass:"Pass: Defensive Player [1]", run:"Run: Defensive Player [4]"},
    14:{pass:"Pass: Defensive Player [2]", run:"Run: Defensive Player [5]"},
    15:{pass:"Pass: Defensive Player [2]", run:"Run: Defensive Player [5]"},
    16:{pass:"Pass: Defensive Player [3]", run:"Run: Defensive Player [6]"},
    17:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
    18:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
    19:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"},
    20:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"}
  },
  fury:  {
    13:{pass:"Pass: SACK! (-1D6 LOSS)", run:"Run: FUMBLE!"},
    14:{pass:"Pass: INTERCEPTION!", run:"Run: MEDIUM GAIN (2D6)"},
    15:{pass:"Pass: LONG GAIN (3D6).", run:"Run: LOSS (-1D6)"},
    16:{pass:"Pass: Defensive Player [5]", run:"Run: Defensive Player [2]"},
    17:{pass:"Pass: LONG GAIN (3D6).", run:"Run: LOSS (-1D6)"},
    18:{pass:"Pass: SACK (-1D6)", run:"Run: LOSS (-1D6)"},
    19:{pass:"Pass: FUMBLE", run:"Run: LONG GAIN (3D6)"},
    20:{pass:"Pass: Offensive Player [12]", run:"Offensive Player [12]"}
  },
  pass:  {
    13:{pass:"Pass: INTERCEPTION!", run:"Run: TOUCHDOWN!"},
    14:{pass:"Pass: INTERCEPTION!", run:"Run: SHORT GAIN (1D6)"},
    15:{pass:"Pass: INCOMPLETE!", run:"Run: MEDIUM GAIN (2D6)"},
    16:{pass:"Pass: INCOMPLETE!", run:"Run: Offensive Player [12]"},
    17:{pass:"Pass: INTERCEPTION!", run:"Run: LONG GAIN (3D6)"},
    18:{pass:"Pass: INTERCEPTION!", run:"Run: MEDIUM GAIN (2D6)"},
    19:{pass:"Pass: INCOMPLETE!", run:"Run: LONG GAIN (3D6)"},
    20:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"}
  },
  run:   {
    13:{pass:"Pass: LONG GAIN (3D6)", run:"Run: LOSS (-1D6)"},
    14:{pass:"Pass: LONG GAIN (3D6)", run:"Run: LONG GAIN (3D6)"},
    15:{pass:"Pass: SHORT GAIN (1D6)", run:"Run: NO GAIN."},
    16:{pass:"Pass: Offensive Player [12]", run:"Run: Defensive Player [5]"},
    17:{pass:"Pass: LONG GAIN (3D6)", run:"Run: LOSS (-1D6)"},
    18:{pass:"Pass: MEDIUM GAIN (2D6)", run:"Run: LOSS (-1D6)"},
    19:{pass:"Pass: MEDIUM GAIN (2D6)", run:"Run: SHORT GAIN (1D6)"},
    20:{pass:"Pass: Offensive Player [12]", run:"Run: Offensive Player [12]"}
  }
};

const defaultData = {
  meta: { name: "Fury Football Set", version: 13 },
  furyDieFaces: ["▲","●","●","●","■","■"],
  furyEffects: { "▲":"Triangle effect", "●":"No special", "■":"Fury note" },
  zoneNames: { white: "White Zone", red: "Red Zone" },
  coaches: { homeOff:"Default", homeDef:"Default", awayOff:"Default", awayDef:"Default" }
};

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? JSON.parse(raw) : structuredClone(defaultData);
    return migrateState(parsed);
  }catch(e){
    return structuredClone(defaultData);
  }
}

function migrateState(s){
  if (!s || typeof s !== 'object') s = {};
  if (!s.meta) s.meta = structuredClone(defaultData.meta);
  if (!Array.isArray(s.furyDieFaces)) s.furyDieFaces = structuredClone(defaultData.furyDieFaces);
  if (!s.furyEffects || typeof s.furyEffects !== 'object') s.furyEffects = structuredClone(defaultData.furyEffects);
  if (!s.zoneNames || typeof s.zoneNames !== 'object') s.zoneNames = structuredClone(defaultData.zoneNames);
  if (!s.coaches || typeof s.coaches !== 'object') s.coaches = structuredClone(defaultData.coaches);
  s.coaches.homeOff ??= "Default";
  s.coaches.homeDef ??= "Default";
  s.coaches.awayOff ??= "Default";
  s.coaches.awayDef ??= "Default";
  return s;
}

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); }

/* RNG */
function mulberry32(a){return function(){var t=(a+=0x6d2b79f5);t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296}}
function seedToRng(seed){ if(!seed) return Math.random; let s=0; for(let i=0;i<seed.length;i++) s=(s*31+seed.charCodeAt(i))>>>0; return mulberry32(s||1) }
const rollD=(rng,s)=>Math.floor(rng()*s)+1;

/* App State */
let State = loadState();
let History = [];
function $(q){return document.querySelector(q)}
function $all(q){return Array.from(document.querySelectorAll(q))}
function pickTendency(offMap, zone){
  let pass=0, run=0;
  for (let i=1;i<=6;i++){
    const v = offMap?.[zone]?.[i]?.call?.toLowerCase();
    if (v==="pass") pass++; else if (v==="run") run++;
  }
  return (pass>=run) ? 'pass' : 'run'; // used only for labels when needed – we DO NOT auto-pick outcome anymore
}
function defenseToChart(choice){
  const c=(choice||'').toLowerCase();
  if (c==='gotcha') return 'gotcha';
  if (['react','pass','run','fury'].includes(c)) return c;
  return 'react';
}
function updateTeamBadges(){
  const pos = document.querySelector('input[name="pos"]:checked').value;
  const offTeam = pos; const defTeam = pos==='home'?'away':'home';
  $('#offTeamTag').textContent = (offTeam==='home'?'Home':'Visitor')+' Offense';
  $('#defTeamTag').textContent = (defTeam==='home'?'Home':'Visitor')+' Defense';
}

/* === Renderers === */
function renderAll(){
  State = migrateState(State);

  $('#furyFacesPreview').textContent=(State.furyDieFaces||[]).join(' ');
  const facesGrid=$('#furyFacesGrid'); facesGrid.innerHTML='';
  (State.furyDieFaces||[]).forEach((f,i)=>{
    const inp=document.createElement('input'); inp.className='input'; inp.value=f;
    inp.oninput=()=>{ State.furyDieFaces[i]=inp.value; saveState(); $('#furyFacesPreview').textContent=State.furyDieFaces.join(' '); };
    facesGrid.appendChild(inp);
  });
  const effGrid=$('#furyEffectsGrid'); effGrid.innerHTML='';
  Array.from(new Set(State.furyDieFaces)).forEach(sym=>{
    const wrap=document.createElement('div'); wrap.className='ibox';
    wrap.innerHTML = `<div class="t">Effect for <b>${sym}</b></div>`;
    const ta=document.createElement('textarea'); ta.className='input'; ta.value=State.furyEffects?.[sym]||'';
    ta.oninput=()=>{ State.furyEffects[sym]=ta.value; saveState(); };
    wrap.appendChild(ta); effGrid.appendChild(wrap);
  });

  const offKeys=Object.keys(COACH_PRESETS.offense);
  const defKeys=Object.keys(COACH_PRESETS.defense);
  function fillSelect(sel, keys, val){
    sel.innerHTML = keys.map(k=>`<option value="${k}">${k}</option>`).join('');
    sel.value = (val && keys.includes(val)) ? val : keys[0];
  }
  const c = State.coaches || {};
  fillSelect($('#selHomeOff'), offKeys, c.homeOff || "Default");
  fillSelect($('#selHomeDef'), defKeys, c.homeDef || "Default");
  fillSelect($('#selAwayOff'), offKeys, c.awayOff || "Default");
  fillSelect($('#selAwayDef'), defKeys, c.awayDef || "Default");

  $('#selHomeOff').onchange = e=>{ State.coaches.homeOff=e.target.value; saveState(); };
  $('#selHomeDef').onchange = e=>{ State.coaches.homeDef=e.target.value; saveState(); };
  $('#selAwayOff').onchange = e=>{ State.coaches.awayOff=e.target.value; saveState(); };
  $('#selAwayDef').onchange = e=>{ State.coaches.awayDef=e.target.value; saveState(); };

  updateTeamBadges();
  renderResultPanel(null);
  renderHistory();
}

/* Result + History UI */
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function renderResultPanel(last){
  const panel=$('#resultPanel');
  if(!last){ panel.innerHTML='<div class="sub">Ready. Select coaches, zone, and possession then roll.</div>'; return; }

  const zoneLabel=State.zoneNames?.[last.zone]||(last.zone==='red'?'Red Zone':'White Zone');
  const offTeamLbl = last.offTeam==='home'?'Home Offense':'Visitor Offense';
  const defTeamLbl = last.defTeam==='home'?'Home Defense':'Visitor Defense';

  let routeHTML='';
  if(last.route.type==='player'){
    routeHTML=`<p><b>Route:</b> Player Card Check — d20=${last.route.number}${last.route.gotchaMatched?` <span class="badge">Gotcha (guessed right)</span>`:''}${last.audibleIsTendency?` <span class="badge">Audible: TENDENCY</span>`:''}.</p>`;
  }else if(last.route.type==='chart-both'){
    routeHTML=`<p><b>Route:</b> <b>${last.route.chart.toUpperCase()}</b> • #${last.route.number} • <b>TENDENCY</b>${last.route.gotchaAudible?` <span class="badge">Gotcha vs Audible → Fury</span>`:''}${last.route.gotchaMatched?` <span class="badge">Gotcha (guessed right)</span>`:''}</p>`;
  }else{
    routeHTML=`<p><b>Route:</b> <b>${last.route.chart.toUpperCase()}</b> • #${last.route.number} • <b>${last.route.call.toUpperCase()}</b>${last.route.gotchaMatched?` <span class="badge">Gotcha (guessed right)</span>`:''}</p>`;
  }

  panel.innerHTML=`
    <div class="grid grid-4" style="gap:8px;margin-bottom:8px;">
      <span class="badge">Zone: ${zoneLabel}</span>
      <span class="badge">Possession: ${(last.offTeam==='home'?'Home':'Visitor')}</span>
      <span class="badge">d20: ${last.d20}</span>
      <span class="badge">Off die (${offTeamLbl}): ${last.black}</span>
      <span class="badge">Def die (${defTeamLbl}): ${last.white}</span>
      <span class="badge">Fury: ${last.furyFace}</span>
      <span class="badge">Short: ${last.shortD6}</span>
      <span class="badge">Medium: ${last.medium2D6.total}</span>
      <span class="badge">Long: ${last.long3D6.total}</span>
    </div>
    <div class="mono" style="margin:-6px 0 8px 0; color:#475569;">
      <span>Medium rolls: [${last.medium2D6.rolls.join(', ')}]</span> •
      <span>Long rolls: [${last.long3D6.rolls.join(', ')}]</span>
    </div>
    <div style="margin-bottom:8px;">${routeHTML}</div>
    <div class="grid grid-3">
      <div class="ibox"><div class="t">Offense Call</div>
        <div>
          ${last.offense?`<div>Call: <b>${(last.offense.call||'').toUpperCase()}</b>${last.audibleIsTendency?` → <b>TENDENCY</b>`:''}</div>${last.offense.note?`<div class="muted" style="font-size:.85rem;">${last.offense.note}</div>`:''}`:'<i>Not set</i>'}
        </div>
      </div>
      <div class="ibox"><div class="t">Defense</div>
        <div>${last.defense?`<div>Choice: <b>${(last.defense.choice||'').toUpperCase()}</b></div>${last.defense.note?`<div class="muted" style="font-size:.85rem;">${last.defense.note}</div>`:''}`:'<i>Not set</i>'}</div>
      </div>
      <div class="ibox"><div class="t">Fury Effect</div><div><b>${last.furyFace}</b>: ${last.furyEffect||'No special effect'}</div></div>
    </div>
    ${last.result?`<div class="result" style="margin-top:8px;"><div class="t" style="font-weight:700;">Result</div><div>${last.result}</div></div>`:''}
  `;
}
function renderHistory(){
  const box=$('#history');
  if(!History.length){ box.innerHTML=`<div class="muted" style="font-size:.9rem;">No rolls yet.</div>`; return; }
  box.innerHTML=History.map(h=>`
    <div class="histItem">
      <div class="histRow">
        <span class="badge">${h.offTeam==='home'?'Home':'Visitor'} ball</span>
        <span class="badge">d20 ${h.d20}</span>
        <span class="badge">Off ${h.black}</span>
        <span class="badge">Def ${h.white}</span>
        <span class="badge">Fury ${h.furyFace}</span>
        <span class="badge">Short ${h.shortD6}</span>
        <span class="badge">Medium ${h.medium2D6.total}</span>
        <span class="badge">Long ${h.long3D6.total}</span>
        <span class="badge">${h.zone}</span>
        ${h.route.gotchaMatched?'<span class="badge">Gotcha (right)</span>':''}
        ${h.route.gotchaAudible?'<span class="badge">Gotcha→Fury</span>':''}
        ${h.audibleIsTendency?'<span class="badge">Audible: TENDENCY</span>':''}
      </div>
      <div class="mono" style="margin:4px 0 4px 0; color:#475569;">
        Medium: [${h.medium2D6.rolls.join(', ')}] • Long: [${h.long3D6.rolls.join(', ')}]
      </div>
      <div style="font-size:.9rem;">
        ${
          h.route.type==='player' ? 'Player card check.'
          : h.route.type==='chart-both'
            ? `${h.route.chart.toUpperCase()} #${h.route.number} TENDENCY (see both)`
            : `${h.route.chart.toUpperCase()} #${h.route.number} ${h.route.call.toUpperCase()}`
        }
      </div>
      ${h.result?`<div class="sub" style="margin-top:4px;">${h.result}</div>`:''}
    </div>
  `).join('');
}

/* === Rolling Logic (Audible = TENDENCY, no auto pick) === */
function rollAll(){
  const zone=$('#zone').value;
  const rng=seedToRng($('#seed').value.trim());
  const d20=rollD(rng,20), black=rollD(rng,6), white=rollD(rng,6), furyIdx=rollD(rng,6);

  // Extra yardage dice
  const shortD6 = rollD(rng,6);
  const m1 = rollD(rng,6), m2 = rollD(rng,6);
  const l1 = rollD(rng,6), l2 = rollD(rng,6), l3 = rollD(rng,6);

  // Update previews
  $('#shortVal').textContent = shortD6;
  $('#mediumVal').textContent = (m1+m2);
  $('#mediumBreak').textContent = `[${m1}, ${m2}]`;
  $('#longVal').textContent = (l1+l2+l3);
  $('#longBreak').textContent = `[${l1}, ${l2}, ${l3}]`;

  const furyFace=(State.furyDieFaces&&State.furyDieFaces[furyIdx-1])||["▲","●","●","●","■","■"][furyIdx-1];

  // Possession decides which team's coaches are used
  const pos = document.querySelector('input[name="pos"]:checked').value; // 'home'|'away'
  const offTeam = pos;
  const defTeam = pos==='home'?'away':'home';

  const offCoachName = (offTeam==='home') ? State.coaches.homeOff : State.coaches.awayOff;
  const defCoachName = (defTeam==='home') ? State.coaches.homeDef : State.coaches.awayDef;

  const offMap = COACH_PRESETS.offense[offCoachName] || COACH_PRESETS.offense.Default;
  const defMap = COACH_PRESETS.defense[defCoachName] || COACH_PRESETS.defense.Default;

  const off = offMap?.[zone]?.[black];
  const def = defMap?.[zone]?.[white];

  let playResult=null;
  let route=null;

  const offCallRaw=(off&&off.call)?off.call:'run';
  const defChoiceRaw=(def&&def.choice)?def.choice:'react';

  const isAudible = (offCallRaw||'').toLowerCase()==='audible';
  const defChoice = defenseToChart(defChoiceRaw);

  // resolve helper: build a "both lines" result for TENDENCY charts
  function resultBoth(chartName, num){
    const row = PLAY_CHARTS[chartName]?.[num] || {};
    const passTxt = row.pass || '(no pass entry)';
    const runTxt  = row.run  || '(no run entry)';
    return `<b>${chartName.toUpperCase()} ${num}</b><br>Pass → ${escapeHTML(passTxt)}<br>Run → ${escapeHTML(runTxt)}`;
  }

  if(defChoice==='gotcha' && isAudible){
    // Gotcha + Audible => FURY chart, show TENDENCY with both lines
    const num = (d20>=13 && d20<=20) ? d20 : (13 + ((d20-1)%8));
    playResult = resultBoth('fury', num);
    route = { type:'chart-both', chart:'fury', number:num, gotchaAudible:true };
  } else if (defChoice==='gotcha'){
    // Gotcha guessed right: if OFF was not audible, we know pass/run from offCallRaw
    if (d20>=13 && d20<=20){
      if (isAudible){
        // audible + gotcha is already handled above; this branch only when not audible
        // (kept for safety)
      }
      const offCall = (offCallRaw||'run').toLowerCase(); // pass or run from preset
      const row = PLAY_CHARTS[offCall]?.[d20] || {};
      const txt = offCall==='pass' ? row.pass : row.run;
      playResult = escapeHTML(txt || `No entry for ${offCall.toUpperCase()} ${d20}.`);
      route = { type:'chart', chart:offCall, call:offCall, number:d20, gotchaMatched:true };
    } else {
      // 1–12: still a player check; annotate gotcha
      route = { type:'player', number:d20, gotchaMatched:true };
      playResult = null;
    }
  } else {
    // Normal resolution: defense decides which chart (react/pass/run/fury)
    if(d20>=13 && d20<=20){
      const chartName = defChoice;
      if (isAudible){
        // TENDENCY: show both lines, do not choose
        playResult = resultBoth(chartName, d20);
        route = { type:'chart-both', chart:chartName, number:d20, gotchaAudible:false };
      } else {
        // Off had explicit pass/run
        const offCall = (offCallRaw||'run').toLowerCase();
        const row = PLAY_CHARTS[chartName]?.[d20] || {};
        const txt = offCall==='pass' ? row.pass : row.run;
        playResult = escapeHTML(txt || `No entry for ${chartName.toUpperCase()} ${d20} ${offCall.toUpperCase()}.`);
        route = { type:'chart', chart:chartName, call:offCall, number:d20 };
      }
    } else {
      // 1–12 player check; if audible, just flag TENDENCY for display
      route = { type:'player', number:d20 };
      playResult = null;
    }
  }

  const furyEffect=(State.furyEffects&&State.furyEffects[furyFace])||'No special effect';

  const entry={
    ts:Date.now(), zone, d20, black, white, furyIdx, furyFace,
    offTeam, defTeam,
    offense:off, defense:def, route, result:playResult, furyEffect,
    audibleIsTendency: isAudible,
    shortD6,
    medium2D6: { total: m1+m2, rolls: [m1,m2] },
    long3D6:   { total: l1+l2+l3, rolls: [l1,l2,l3] }
  };
  History.unshift(entry); History=History.slice(0,60);
  renderResultPanel(entry); renderHistory();
}

/* Import / Export */
function exportJSON(){
  const data = { meta: State.meta, furyDieFaces: State.furyDieFaces, furyEffects: State.furyEffects, zoneNames: State.zoneNames, coaches: State.coaches };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; const name=(State.meta&&State.meta.name)?State.meta.name.replace(/\s+/g,'-'):'dataset';
  a.download=`fury-football-${name}.json`; a.click(); URL.revokeObjectURL(url);
}
function importJSON(file){
  const r=new FileReader();
  r.onload=e=>{
    try{
      const obj=JSON.parse(e.target.result);
      State = migrateState({
        ...State,
        ...obj,
        coaches: { ...(State.coaches||{}), ...(obj.coaches||{}) }
      });
      saveState(); renderAll();
    }catch(_){ alert('Invalid JSON file.'); }
  };
  r.readAsText(file);
}

/* Wire Up */
window.addEventListener('DOMContentLoaded', ()=>{
  renderAll();
  $('#btnRoll').onclick=rollAll;
  $('#btnClear').onclick=()=>{History=[];renderHistory();renderResultPanel(null);
    $('#shortVal').textContent='1d6';
    $('#mediumVal').textContent='2d6'; $('#mediumBreak').textContent='';
    $('#longVal').textContent='3d6'; $('#longBreak').textContent='';
  };
  $('#btnExport').onclick=exportJSON;
  $('#fileImport').onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; };

  $all('input[name="pos"]').forEach(r=>r.onchange=updateTeamBadges);
});
</script>
</body>
</html>

